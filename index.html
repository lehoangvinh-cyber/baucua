<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinity Game Pro v5.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />

    <style>
        :root { --primary: #ff3d00; --gold: #ffc400; --bg: #0a0b10; --card: #161b22; --green: #1b5e20; }
        body { font-family: 'Lexend', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 10px; display: flex; justify-content: center; }
        
        .app-grid { width: 100%; max-width: 1200px; display: grid; grid-template-columns: 1fr 340px; gap: 20px; }
        @media (max-width: 900px) { .app-grid { grid-template-columns: 1fr; } }
        
        .main-stage { background: var(--card); padding: 25px; border-radius: 28px; border: 1px solid #30363d; min-height: 650px; position: relative; }
        .nav { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 18px; margin-bottom: 25px; }
        
        /* Fix l·ªói hi·ªÉn th·ªã icon x√∫c x·∫Øc */
        .dice-board { display: flex; justify-content: center; gap: 15px; margin: 25px 0; background: #0d1117; padding: 25px; border-radius: 24px; border: 1px solid #30363d; }
        .dice-container { width: 80px; height: 80px; background: #fff; border-radius: 16px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .dice-container img { width: 70px; height: 70px; object-fit: contain; }
        
        /* ƒê∆∞·ªùng ƒëua ng·ª±a */
        .track { background: var(--green); padding: 15px; border-radius: 20px; border: 4px solid #000; position: relative; }
        .lane { height: 50px; border-bottom: 1px dashed rgba(255,255,255,0.2); position: relative; display: flex; align-items: center; width: 100%; }
        .horse { font-size: 32px; position: absolute; left: 0; transition: left 0.3s linear; white-space: nowrap; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }

        .side-box { background: var(--card); border-radius: 24px; border: 1px solid #30363d; margin-bottom: 20px; overflow: hidden; }
        #chat-content, #hist-content { height: 280px; overflow-y: auto; padding: 15px; font-size: 13px; scroll-behavior: smooth; }
        
        .auth-card { background: var(--card); padding: 45px; border-radius: 32px; border: 1px solid var(--gold); width: 360px; text-align: center; margin-top: 10vh; box-shadow: 0 15px 40px rgba(0,0,0,0.6); }
        .auth-card input { width: 100%; padding: 14px; margin: 12px 0; border-radius: 12px; border: 1px solid #30363d; background: #0d1117; color: #fff; box-sizing: border-box; }

        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 40px; }
        .menu-item { background: #21262d; border: 1px solid #30363d; border-radius: 24px; padding: 30px; text-align: center; cursor: pointer; transition: 0.3s; }
        .menu-item:hover { border-color: var(--gold); transform: translateY(-5px); background: rgba(255,196,0,0.05); }
        .menu-item .icon { font-size: 48px; display: block; margin-bottom: 15px; color: var(--gold); }

        .hidden { display: none; }
        .shaking { animation: shake 0.15s infinite; }
        @keyframes shake { 0% { transform: translate(2px, 1px); } 50% { transform: translate(-2px, -1px); } 100% { transform: translate(1px, 1px); } }
        
        #play-btn { width: 100%; padding: 18px; background: var(--primary); color: #fff; border: none; border-radius: 16px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 25px; box-shadow: 0 5px 0 #b71c1c; }
        #play-btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #b71c1c; }
        .active-bet { border: 2px solid var(--gold) !important; background: rgba(255,196,0,0.1) !important; }
    </style>
</head>
<body>

<div id="view-auth" class="auth-card">
    <h1 style="color: var(--gold); margin-bottom: 30px;">INFINITY</h1>
    <div id="auth-inputs">
        <input type="text" id="reg-name" placeholder="T√™n hi·ªÉn th·ªã" class="hidden">
        <input type="email" id="acc-email" placeholder="Email">
        <input type="password" id="acc-pass" placeholder="M·∫≠t kh·∫©u">
        <button onclick="handleAuth()" id="btn-auth" style="width:100%; padding:15px; background:var(--gold); border:none; border-radius:12px; font-weight:bold; cursor:pointer; color:#000; text-transform:uppercase;">V√†o Game</button>
        <p onclick="forgotPass()" style="color:var(--primary); font-size:12px; cursor:pointer; margin-top:15px;">Qu√™n m·∫≠t kh·∫©u?</p>
        <p onclick="toggleAuth()" id="toggle-txt" style="color:#aaa; font-size:13px; cursor:pointer;">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay</p>
    </div>
</div>

<div id="view-game" class="app-grid hidden">
    <div class="main-stage">
        <div class="nav">
            <div style="display:flex; align-items:center; gap:10px;"><span class="material-symbols-rounded">account_circle</span><b id="user-name">...</b></div>
            <select id="mode-sel" onchange="switchMode()" style="background:#000; color:#fff; border:1px solid #30363d; padding:8px; border-radius:10px;">
                <option value="multi">üåê Ch∆°i Chung</option>
                <option value="solo">üë§ Ch∆°i Ri√™ng</option>
            </select>
            <div style="color: var(--gold); font-size: 20px; font-weight: bold;">üí∞ <span id="balance">0</span></div>
            <button onclick="logout()" style="background:none; border:none; color:#ff4444; cursor:pointer;"><span class="material-symbols-rounded">logout</span></button>
        </div>

        <div id="status-msg" style="text-align:center; font-weight:bold; color: var(--gold); min-height: 30px; font-size: 18px;"></div>

        <div id="screen-menu" class="menu-grid">
            <div class="menu-item" onclick="openGame('bc')"><span class="icon material-symbols-rounded">casino</span>B·∫ßu Cua</div>
            <div class="menu-item" onclick="openGame('tx')"><span class="icon material-symbols-rounded">payments</span>T√†i X·ªâu</div>
            <div class="menu-item" onclick="openGame('xd')"><span class="icon material-symbols-rounded">brightness_high</span>X√≥c ƒêƒ©a</div>
            <div class="menu-item" onclick="openGame('dn')"><span class="icon material-symbols-rounded">bakery_dining</span>ƒêua Ng·ª±a</div>
        </div>

        <div id="screen-bc" class="hidden">
            <button onclick="openGame('menu')" style="color:#888; background:none; border:none; cursor:pointer; display:flex; align-items:center;"><span class="material-symbols-rounded">arrow_back</span> Quay l·∫°i</button>
            <div class="dice-board">
                <div class="dice-container"><img id="d-bc-0" src="https://img.icons8.com/color/144/help.png"></div>
                <div class="dice-container"><img id="d-bc-1" src="https://img.icons8.com/color/144/help.png"></div>
                <div class="dice-container"><img id="d-bc-2" src="https://img.icons8.com/color/144/help.png"></div>
            </div>
            <div id="bc-bets" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;"></div>
        </div>

        <div id="screen-dn" class="hidden">
            <button onclick="openGame('menu')" style="color:#888; background:none; border:none; cursor:pointer; display:flex; align-items:center;"><span class="material-symbols-rounded">arrow_back</span> Quay l·∫°i</button>
            <div class="track" style="margin:25px 0;">
                <div class="lane"><div id="h-0" class="horse">üèá</div></div>
                <div class="lane"><div id="h-1" class="horse">üèá</div></div>
                <div class="lane"><div id="h-2" class="horse">üèá</div></div>
                <div class="lane"><div id="h-3" class="horse">üèá</div></div>
            </div>
            <div id="dn-bets" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px;"></div>
        </div>

        <button id="play-btn" class="hidden" onclick="masterRun()">B·∫ÆT ƒê·∫¶U PHI√äN</button>
    </div>

    <div class="side-panel">
        <div class="side-box"><div style="padding:15px; font-weight:bold; color:var(--gold); display:flex; align-items:center; gap:8px;"><span class="material-symbols-rounded">history</span> L·ªäCH S·ª¨</div><div id="hist-content"></div></div>
        <div class="side-box">
            <div id="chat-content"></div>
            <div style="display:flex; padding:12px; gap:8px; background:#0d1117;">
                <input type="text" id="chat-inp" placeholder="Nh·∫≠p tin nh·∫Øn..." style="flex:1; border:none; background:#21262d; color:#fff; padding:10px; border-radius:8px;">
                <button onclick="sendChat()" style="background:var(--gold); border:none; padding:0 15px; border-radius:8px; cursor:pointer; font-weight:bold;">></button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG (C·∫¶N ƒêI·ªÄN TH√îNG TIN C·ª¶A B·∫†N) ---
    const firebaseConfig = {
  apiKey: "AIzaSyA41b97JGMfwxG8YYeS6gpNREJDdNTm1zs",
  authDomain: "game-ddf58.firebaseapp.com",
  databaseURL: "https://game-ddf58-default-rtdb.firebaseio.com",
  projectId: "game-ddf58",
  storageBucket: "game-ddf58.firebasestorage.app",
  messagingSenderId: "1044515984576",
  appId: "1:1044515984576:web:dfe285553142875849c925",
  measurementId: "G-0Q7VVDPWRP"
};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); const db = firebase.database();

    let curScr = 'menu'; let balance = 0; let isHost = false; let user = null; let isReg = false; let pMode = 'multi';
    let bets = { bc: [0,0,0,0,0,0], dn: [0,0,0,0] };
    
    // Icon B·∫ßu Cua ·ªïn ƒë·ªãnh (Link CDN tin c·∫≠y)
    const bcImgs = [
        'https://cdn-icons-png.flaticon.com/512/2329/2329865.png', // Bau
        'https://cdn-icons-png.flaticon.com/512/1046/1046368.png', // Cua
        'https://cdn-icons-png.flaticon.com/512/2515/2515183.png', // Tom
        'https://cdn-icons-png.flaticon.com/512/2271/2271313.png', // Ca
        'https://cdn-icons-png.flaticon.com/512/2632/2632839.png', // Ga
        'https://cdn-icons-png.flaticon.com/512/2395/2395796.png'  // Nai
    ];

    // Kh·ªüi t·∫°o b√†n c∆∞·ª£c
    const bcNames = ['B·∫ßu','Cua','T√¥m','C√°','G√†','Nai'];
    bcNames.forEach((name, idx) => {
        document.getElementById('bc-bets').innerHTML += `
            <div style="background:#21262d; padding:15px; border-radius:20px; text-align:center;">
                <img src="${bcImgs[idx]}" style="width:45px; margin-bottom:5px;">
                <input type="number" id="in-bc-${idx}" style="width:85%; background:#000; color:var(--gold); border:none; text-align:center; border-radius:5px; padding:4px;" placeholder="0">
            </div>`;
    });
    for(let i=0; i<4; i++) {
        document.getElementById('dn-bets').innerHTML += `<div style="background:#21262d; padding:15px; border-radius:20px; text-align:center; font-weight:bold;">üèá Ng·ª±a ${i+1}<br><input type="number" id="in-dn-${i}" style="width:85%; background:#000; color:var(--gold); border:none; text-align:center; padding:4px; margin-top:5px; border-radius:5px;" placeholder="0"></div>`;
    }

    // --- X√ÅC TH·ª∞C ---
    function toggleAuth() { isReg = !isReg; document.getElementById('reg-name').classList.toggle('hidden', !isReg); document.getElementById('btn-auth').innerText = isReg ? "ƒêƒÉng k√Ω t√†i kho·∫£n" : "ƒêƒÉng Nh·∫≠p"; }
    function handleAuth() {
        const e = document.getElementById('acc-email').value, p = document.getElementById('acc-pass').value, n = document.getElementById('reg-name').value;
        if(isReg) auth.createUserWithEmailAndPassword(e, p).then(u => u.user.updateProfile({displayName: n})).then(() => location.reload()).catch(err => alert(err.message));
        else auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
    }
    auth.onAuthStateChanged(u => {
        if(u) {
            user = u; document.getElementById('view-auth').classList.add('hidden'); document.getElementById('view-game').classList.remove('hidden');
            document.getElementById('user-name').innerText = u.displayName || u.email.split('@')[0];
            db.ref('users/'+u.uid).on('value', s => { balance = s.val()?.bal || 2000; if(!s.val()) db.ref('users/'+u.uid).set({bal: 2000}); document.getElementById('balance').innerText = balance.toLocaleString(); });
            db.ref('hist/'+u.uid).limitToLast(12).on('value', s => {
                const h = document.getElementById('hist-content'); h.innerHTML = ""; let a = []; s.forEach(c => a.unshift(c.val()));
                a.forEach(i => h.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #333;"><span>${i.g}</span><b style="color:${i.a>0?'#4caf50':'#f44336'}">${i.a>0?'+':''}${i.a.toLocaleString()}</b></div>`);
            });
            db.ref('online/'+u.uid).set({name: u.displayName||u.email, t: Date.now()}); db.ref('online/'+u.uid).onDisconnect().remove();
        }
    });

    // --- H·ªÜ TH·ªêNG GAME ---
    function openGame(s) { ['screen-menu','screen-bc','screen-dn'].forEach(x => {if(document.getElementById(x)) document.getElementById(x).classList.add('hidden')}); document.getElementById('screen-'+s).classList.remove('hidden'); curScr = s; switchMode(); }
    
    function switchMode() {
        pMode = document.getElementById('mode-sel').value;
        if(pMode === 'solo') { document.getElementById('play-btn').classList.remove('hidden'); }
        else {
            db.ref('online').orderByChild('t').on('value', s => {
                let us = []; s.forEach(c => us.push(c.key)); isHost = (us[0] === user?.uid);
                document.getElementById('play-btn').classList.toggle('hidden', !isHost);
            });
        }
    }

    function masterRun() {
        if(pMode === 'multi' && !isHost) return;
        let t = calculateTotal();
        if(t > balance) return alert("H·∫øt xu!");
        if(t <= 0 && pMode === 'solo') return alert("Vui l√≤ng ƒë·∫∑t c∆∞·ª£c!");

        deduct(t);
        if(pMode === 'solo') {
            if(curScr === 'dn') startLocalRace(); else localShake();
        } else {
            const r = 'room_'+curScr; db.ref(r+'/sid').transaction(c => (c||0)+1);
            if(curScr === 'dn') startGlobalRace(r);
            else {
                db.ref(r).update({status: 'shaking'});
                setTimeout(() => db.ref(r).update({status: 'ready', res: [rnd(6), rnd(6), rnd(6)], t: Date.now()}), 1500);
            }
        }
    }

    function calculateTotal() {
        let t = 0;
        if(curScr==='bc') for(let i=0;i<6;i++) t += parseInt(document.getElementById('in-bc-'+i).value)||0;
        if(curScr==='dn') for(let i=0;i<4;i++) t += parseInt(document.getElementById('in-dn-'+i).value)||0;
        return t;
    }

    function deduct(t) {
        if(curScr==='bc') for(let i=0;i<6;i++) bets.bc[i] = parseInt(document.getElementById('in-bc-'+i).value)||0;
        if(curScr==='dn') for(let i=0;i<4;i++) bets.dn[i] = parseInt(document.getElementById('in-dn-'+i).value)||0;
        if(t > 0) { 
            db.ref('users/'+user.uid).update({bal: balance - t}); 
            db.ref('hist/'+user.uid).push({g: curScr.toUpperCase(), a: -t}); 
        }
    }

    function rnd(n) { return Math.floor(Math.random()*n); }

    function localShake() {
        document.querySelectorAll('#screen-'+curScr+' img').forEach(i => i.classList.add('shaking'));
        setTimeout(() => {
            document.querySelectorAll('#screen-'+curScr+' img').forEach(i => i.classList.remove('shaking'));
            let r = [rnd(6), rnd(6), rnd(6)];
            r.forEach((v,i) => document.getElementById('d-bc-'+i).src = bcImgs[v]);
            calc(r);
        }, 1500);
    }

    // FIXED: LOGIC ƒêUA NG·ª∞A
    function startLocalRace() {
        let p = [0,0,0,0]; 
        let t = setInterval(() => {
            p = p.map(x => x + Math.floor(Math.random() * 6) + 2);
            p.forEach((v,i) => {
                let pos = v > 90 ? 90 : v;
                document.getElementById('h-'+i).style.left = pos + '%';
            });
            if(p.some(x => x >= 90)) { 
                clearInterval(t); 
                let winner = p.indexOf(Math.max(...p)); 
                calc(p, winner); 
            }
        }, 150ms);
    }

    function startGlobalRace(r
