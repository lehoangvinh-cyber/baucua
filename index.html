<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si√™u ·ª®ng D·ª•ng Game Online</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #d32f2f; --gold: #ffc107; --bg: #1a1a1a; --dark-card: #2c2c2c; --green: #2e7d32; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; justify-content: center; }
        
        /* Auth Styles */
        .auth-box { background: var(--dark-card); padding: 30px; border-radius: 20px; border: 2px solid var(--gold); width: 350px; text-align: center; margin-top: 50px; }
        .auth-box input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #333; color: white; box-sizing: border-box; }
        .auth-box button { width: 100%; padding: 12px; background: var(--gold); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        /* Layout */
        .game-container { width: 100%; max-width: 1100px; display: grid; grid-template-columns: 1fr 320px; gap: 20px; }
        @media (max-width: 900px) { .game-container { grid-template-columns: 1fr; } }
        
        .main-panel { background: var(--dark-card); padding: 20px; border-radius: 20px; border: 2px solid var(--gold); min-height: 600px; position: relative; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #333; padding: 12px; border-radius: 12px; margin-bottom: 20px; }
        
        /* Game Components */
        .dice-board { display: flex; justify-content: center; gap: 15px; margin: 20px 0; background: #444; padding: 20px; border-radius: 15px; min-height: 100px; align-items: center; }
        .dice-board img { width: 65px; height: 65px; background: white; border-radius: 10px; }
        .xd-dot { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #333; }
        .dot-red { background: #ff5252; } .dot-white { background: #ffffff; }
        
        .track { background: var(--green); padding: 10px; border-radius: 10px; position: relative; overflow: hidden; }
        .lane { height: 40px; border-bottom: 1px dashed rgba(255,255,255,0.2); position: relative; display: flex; align-items: center; }
        .horse { font-size: 24px; position: absolute; left: 0; transition: left 0.2s linear; }

        /* Sidebar & Chat */
        .box { background: #252525; border-radius: 15px; border: 1px solid #444; margin-bottom: 15px; overflow: hidden; }
        #chat-messages { height: 350px; overflow-y: auto; padding: 15px; font-size: 13px; scroll-behavior: smooth; }
        .chat-time { font-size: 10px; color: #777; margin-right: 5px; }
        
        /* Menu */
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 30px; }
        .menu-item { background: #333; border: 2px solid #444; border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; }
        .menu-item:hover { border-color: var(--gold); transform: translateY(-3px); }
        .menu-item img { width: 60px; height: 60px; margin-bottom: 10px; }

        .hidden { display: none; }
        .shaking { animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: rotate(3deg); } 50% { transform: rotate(-3deg); } }
        #play-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .active-bet { border: 2px solid var(--gold) !important; background: #444 !important; }
    </style>
</head>
<body>

<div id="auth-screen" class="auth-box">
    <h2 id="auth-title" style="color: var(--gold);">ƒêƒÇNG NH·∫¨P</h2>
    <input type="text" id="auth-display-name" placeholder="T√™n hi·ªÉn th·ªã (khi ƒëƒÉng k√Ω)" class="hidden">
    <input type="email" id="auth-email" placeholder="Email">
    <input type="password" id="auth-password" placeholder="M·∫≠t kh·∫©u">
    <button onclick="handleAuth()" id="auth-btn">V√†o Game</button>
    <p onclick="forgotPassword()" id="forgot-pw-link" style="color: #d32f2f; font-size: 12px;">Qu√™n m·∫≠t kh·∫©u?</p>
    <p onclick="toggleAuthMode()" id="auth-toggle">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω</p>
</div>

<div id="game-ui" class="game-container hidden">
    <div class="main-panel">
        <div class="header">
            <div>üëã <b id="user-name">...</b> | PHI√äN: #<span id="session-id">0</span></div>
            <div style="color: var(--gold); font-size: 20px;">üí∞ <b id="balance">0</b></div>
            <button onclick="logout()" style="background:none; color:#888; border:none; cursor:pointer;">Tho√°t</button>
        </div>

        <div id="msg" style="text-align:center; font-weight:bold; height: 25px; color: var(--gold); margin-bottom: 10px;"></div>

        <div id="screen-menu">
            <div class="menu-grid">
                <div class="menu-item" onclick="changeScreen('bc')"><img src="https://cdn-icons-png.flaticon.com/512/2329/2329865.png"><br>B·∫ßu Cua</div>
                <div class="menu-item" onclick="changeScreen('tx')"><img src="https://cdn-icons-png.flaticon.com/512/3554/3554832.png"><br>T√†i X·ªâu</div>
                <div class="menu-item" onclick="changeScreen('xd')"><img src="https://cdn-icons-png.flaticon.com/512/1046/1046368.png"><br>X√≥c ƒêƒ©a</div>
                <div class="menu-item" onclick="changeScreen('dn')"><img src="https://cdn-icons-png.flaticon.com/512/3462/3462140.png"><br>ƒêua Ng·ª±a</div>
            </div>
        </div>

        <div id="screen-bc" class="hidden">
            <button onclick="changeScreen('menu')">‚Üê Quay l·∫°i Menu</button>
            <div class="dice-board" id="board-bc">
                <img id="dice-bc-0" src="https://img.icons8.com/color/144/help.png">
                <img id="dice-bc-1" src="https://img.icons8.com/color/144/help.png">
                <img id="dice-bc-2" src="https://img.icons8.com/color/144/help.png">
            </div>
            <div id="bet-bc-area" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;"></div>
        </div>

        <div id="screen-tx" class="hidden">
            <button onclick="changeScreen('menu')">‚Üê Quay l·∫°i Menu</button>
            <div class="dice-board">
                <img id="dice-tx-0" src="https://img.icons8.com/ios-filled/100/ffffff/dice-one.png">
                <img id="dice-tx-1" src="https://img.icons8.com/ios-filled/100/ffffff/dice-one.png">
                <img id="dice-tx-2" src="https://img.icons8.com/ios-filled/100/ffffff/dice-one.png">
            </div>
            <div style="display:flex; gap:10px;">
                <div id="btn-tai" class="menu-item" style="flex:1" onclick="selTX('tai')"><h2>T√ÄI</h2><input type="number" id="val-tai" placeholder="S·ªë xu..." onclick="event.stopPropagation()"></div>
                <div id="btn-xiu" class="menu-item" style="flex:1" onclick="selTX('xiu')"><h2>X·ªàU</h2><input type="number" id="val-xiu" placeholder="S·ªë xu..." onclick="event.stopPropagation()"></div>
            </div>
        </div>

        <div id="screen-xd" class="hidden">
            <button onclick="changeScreen('menu')">‚Üê Quay l·∫°i Menu</button>
            <div class="dice-board" id="board-xd" style="gap:20px;">
                <div id="dot-0" class="xd-dot dot-white"></div><div id="dot-1" class="xd-dot dot-white"></div>
                <div id="dot-2" class="xd-dot dot-white"></div><div id="dot-3" class="xd-dot dot-white"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div id="btn-chan" class="menu-item" style="flex:1" onclick="selXD('chan')"><h2>CH·∫¥N</h2><input type="number" id="val-chan" placeholder="S·ªë xu..." onclick="event.stopPropagation()"></div>
                <div id="btn-le" class="menu-item" style="flex:1" onclick="selXD('le')"><h2>L·∫∫</h2><input type="number" id="val-le" placeholder="S·ªë xu..." onclick="event.stopPropagation()"></div>
            </div>
        </div>

        <div id="screen-dn" class="hidden">
            <button onclick="changeScreen('menu')">‚Üê Quay l·∫°i Menu</button>
            <div class="track" style="margin:20px 0;">
                <div class="lane"><div id="horse-0" class="horse">üèá1</div></div>
                <div class="lane"><div id="horse-1" class="horse">üèá2</div></div>
                <div class="lane"><div id="horse-2" class="horse">üèá3</div></div>
                <div class="lane"><div id="horse-3" class="horse">üèá4</div></div>
            </div>
            <div id="bet-dn-area" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;"></div>
        </div>

        <button id="play-btn" class="hidden" onclick="masterPlay()">B·∫ÆT ƒê·∫¶U PHI√äN (HOST)</button>
    </div>

    <div class="side-panel">
        <div class="box">
            <div style="padding:10px; font-weight:bold; color:var(--gold); border-bottom:1px solid #444;">üü¢ ONLINE (<span id="online-count">0</span>)</div>
            <ul id="user-list" style="list-style:none; padding:10px; margin:0; font-size:12px; max-height: 100px; overflow-y: auto;"></ul>
        </div>
        <div class="box">
            <div id="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Nh·∫Øn tin...">
                <button onclick="sendChat()">></button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. FIREBASE CONFIG ---
    const firebaseConfig = { apiKey: "AIza...", authDomain: "...", databaseURL: "...", projectId: "...", storageBucket: "...", messagingSenderId: "...", appId: "..." };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); const db = firebase.database();

    // --- 2. BI·∫æN TO√ÄN C·ª§C ---
    let curScreen = 'menu'; let balance = 0; let isHost = false; let currentUser = null; let isRegisterMode = false;
    let myBets = { bc: [0,0,0,0,0,0], tx: {type:null, val:0}, xd: {type:null, val:0}, dn: [0,0,0,0] };
    const itemsBC = [{n:'B·∫ßu',i:'2329865'},{n:'Cua',i:'1046368'},{n:'T√¥m',i:'2515183'},{n:'C√°',i:'2271313'},{n:'G√†',i:'2632839'},{n:'Nai',i:'2395796'}];

    // --- 3. KH·ªûI T·∫†O GIAO DI·ªÜN ---
    itemsBC.forEach((item, idx) => {
        document.getElementById('bet-bc-area').innerHTML += `<div style="background:#333; padding:10px; border-radius:10px; text-align:center;"><img src="https://cdn-icons-png.flaticon.com/512/${item.i}/${item.i}.png" style="width:40px;"><br><input type="number" id="in-bc-${idx}" style="width:80%;" placeholder="0"></div>`;
    });
    for(let i=0; i<4; i++) {
        document.getElementById('bet-dn-area').innerHTML += `<div style="background:#333; padding:10px; border-radius:10px; text-align:center;">üèá${i+1}<br><input type="number" id="in-dn-${i}" style="width:80%;" placeholder="0"></div>`;
    }

    // --- 4. AUTH LOGIC ---
    function toggleAuthMode() {
        isRegisterMode = !isRegisterMode;
        document.getElementById('auth-title').innerText = isRegisterMode ? "ƒêƒÇNG K√ù" : "ƒêƒÇNG NH·∫¨P";
        document.getElementById('auth-btn').innerText = isRegisterMode ? "T·∫°o T√†i Kho·∫£n" : "V√†o Game";
        document.getElementById('auth-display-name').classList.toggle('hidden', !isRegisterMode);
    }

    function handleAuth() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const displayName = document.getElementById('auth-display-name').value;
        if(isRegisterMode) {
            auth.createUserWithEmailAndPassword(email, password)
                .then(u => u.user.updateProfile({displayName: displayName}))
                .then(() => location.reload()).catch(e => alert(e.message));
        } else {
            auth.signInWithEmailAndPassword(email, password).catch(e => alert(e.message));
        }
    }

    function forgotPassword() {
        const email = document.getElementById('auth-email').value;
        if(!email) return alert("Vui l√≤ng nh·∫≠p email!");
        auth.sendPasswordResetEmail(email).then(() => alert("ƒê√£ g·ª≠i email kh√¥i ph·ª•c!")).catch(e => alert(e.message));
    }

    auth.onAuthStateChanged(user => {
        if(user) {
            currentUser = user; document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('user-name').innerText = user.displayName || user.email.split('@')[0];
            db.ref('online/'+user.uid).set({name: user.displayName || user.email, time: firebase.database.ServerValue.TIMESTAMP});
            db.ref('online/'+user.uid).onDisconnect().remove();
            db.ref('users/'+user.uid).on('value', s => { 
                balance = s.val()?.bal || 2000; 
                if(!s.val()) db.ref('users/'+user.uid).set({bal: 2000});
                document.getElementById('balance').innerText = balance.toLocaleString(); 
            });
        }
    });

    function logout() { auth.signOut().then(() => location.reload()); }

    // --- 5. SOCIAL LOGIC ---
    db.ref('online').orderByChild('time').on('value', s => {
        const list = document.getElementById('user-list'); list.innerHTML = ""; let users = [];
        s.forEach(c => { users.push(c.key); list.innerHTML += `<li>${c.val().name}</li>`; });
        document.getElementById('online-count').innerText = users.length;
        isHost = (users[0] === currentUser?.uid);
        document.getElementById('play-btn').classList.toggle('hidden', !isHost);
    });

    function sendChat() {
        const inp = document.getElementById('chat-input');
        if(!inp.value.trim()) return;
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        db.ref('chat').push({n:currentUser.displayName || currentUser.email, t:inp.value, time: time});
        inp.value = "";
    }
    document.getElementById('chat-input').addEventListener('keypress', e => { if(e.key === 'Enter') sendChat(); });
    db.ref('chat').limitToLast(15).on('value', s => {
        const m = document.getElementById('chat-messages'); m.innerHTML = "";
        s.forEach(c => { m.innerHTML += `<div style="margin-bottom:5px;"><span class="chat-time">[${c.val().time}]</span><b>${c.val().n}:</b> ${c.val().t}</div>`; });
        m.scrollTop = m.scrollHeight;
    });

    // --- 6. GAME CORE ---
    function changeScreen(s) {
        ['menu','bc','tx','xd','dn'].forEach(x => document.getElementById('screen-'+x).classList.add('hidden'));
        document.getElementById('screen-'+s).classList.remove('hidden');
        curScreen = s; document.getElementById('msg').innerText = "";
    }

    function masterPlay() {
        if(!isHost) return;
        const room = 'room_'+curScreen; let res = [];
        db.ref(room+'/sessionId').transaction(c => (c||0)+1);
        
        if(curScreen === 'bc') res = [rand(6), rand(6), rand(6)];
        if(curScreen === 'tx') res = [rand(6)+1, rand(6)+1, rand(6)+1];
        if(curScreen === 'xd') res = [Math.random()>0.5, Math.random()>0.5, Math.random()>0.5, Math.random()>0.5];
        if(curScreen === 'dn') { startRace(); return; }

        db.ref(room).update({status:'shaking'});
        setTimeout(() => db.ref(room).update({status:'ready', res: res, time: Date.now()}), 1500);
    }

    function startRace() {
        let pos = [0,0,0,0]; 
        let timer = setInterval(() => {
            pos = pos.map(p => p + Math.floor(Math.random()*10));
            if(pos.some(p => p>=90)) {
                clearInterval(timer); let win = pos.indexOf(Math.max(...pos));
                db.ref('room_dn').update({status:'ready', res: pos, win: win, time: Date.now()});
            } else { db.ref('room_dn').update({status:'shaking', res: pos}); }
        }, 300);
    }

    function syncGame(g, data) {
        if(!data || curScreen !== g) return;
        document.getElementById('session-id').innerText = data.sessionId || 0;
        if(data.status === 'shaking') {
            if(!isHost) deduct(g);
            if(g==='bc') [0,1,2].forEach(i => document.getElementById('dice-bc-'+i).classList.add('shaking'));
            if(g==='dn') data.res.forEach((p,i) => document.getElementById('horse-'+i).style.left = p+'%');
        } else if(data.status === 'ready') {
            if(g==='bc') data.res.forEach((v,i) => { const el = document.getElementById('dice-bc-'+i); el.classList.remove('shaking'); el.src = `https://cdn-icons-png.flaticon.com/512/${itemsBC[v].i}/${itemsBC[v].i}.png`; });
            if(g==='tx') data.res.forEach((v,i) => { document.getElementById('dice-tx-'+i).src = `https://img.icons8.com/ios-filled/100/ffffff/dice-${['one','two','three','four','five','six'][v-1]}.png`; });
            if(g==='xd') data.res.forEach((v,i) => { const el = document.getElementById('dot-'+i); el.className = v ? 'xd-dot dot-red' : 'xd-dot dot-white'; });
            if(g==='dn') data.res.forEach((p,i) => document.getElementById('horse-'+i).style.left = p+'%');
            calcWin(g, data);
        }
    }

    function deduct(g) {
        let t = 0;
        if(g==='bc') for(let i=0;i<6;i++) { myBets.bc[i] = parseInt(document.getElementById('in-bc-'+i).value)||0; t+=myBets.bc[i]; }
        if(g==='tx') { const ty = myBets.tx.type; if(ty) { myBets.tx.val = parseInt(document.getElementById('val-'+ty).value)||0; t=myBets.tx.val; } }
        if(g==='xd') { const ty = myBets.xd.type; if(ty) { myBets.xd.val = parseInt(document.getElementById('val-'+ty).value)||0; t=myBets.xd.val; } }
        if(g==='dn') for(let i=0;i<4;i++) { myBets.dn[i] = parseInt(document.getElementById('in-dn-'+i).value)||0; t+=myBets.dn[i]; }
        if(t > 0 && t <= balance) db.ref('users/'+currentUser.uid).update({bal: balance - t});
    }

    function calcWin(g, data) {
        let w = 0;
        if(g==='bc') data.res.forEach(v => { if(myBets.bc[v]>0) w += myBets.bc[v]*2; });
        if(g==='tx') { const s = data.res.reduce((a,b)=>a+b,0); const r = s>=11?'tai':'xiu'; if(myBets.tx.type === r) w = myBets.tx.val*2; }
        if(g==='xd') { const r = data.res.filter(x=>x).length % 2 === 0 ? 'chan' : 'le'; if(myBets.xd.type === r) w = myBets.xd.val*2; }
        if(g==='dn') { if(myBets.dn[data.win]>0) w = myBets.dn[data.win]*4; }
        if(w>0) { db.ref('users/'+currentUser.uid).update({bal: balance + w}); document.getElementById('msg').innerText = "TH·∫ÆNG +"+w; }
        resetBets();
    }

    function resetBets() {
        myBets = { bc: [0,0,0,0,0,0], tx: {type:null, val:0}, xd: {type:null, val:0}, dn: [0,0,0,0] };
        document.querySelectorAll('input').forEach(i => i.value = "");
        document.querySelectorAll('.active-bet').forEach(e => e.classList.remove('active-bet'));
    }

    function selTX(t) { myBets.tx.type = t; document.getElementById('btn-tai').classList.remove('active-bet'); document.getElementById('btn-xiu').classList.remove('active-bet'); document.getElementById('btn-'+t).classList.add('active-bet'); }
    function selXD(t) { myBets.xd.type = t; document.getElementById('btn-chan').classList.remove('active-bet'); document.getElementById('btn-le').classList.remove('active-bet'); document.getElementById('btn-'+t).classList.add('active-bet'); }
    function rand(n) { return Math.floor(Math.random()*n); }

    db.ref('room_bc').on('value', s => syncGame('bc', s.val()));
    db.ref('room_tx').on('value', s => syncGame('tx', s.val()));
    db.ref('room_xd').on('value', s => syncGame('xd', s.val()));
    db.ref('room_dn').on('value', s => syncGame('dn', s.val()));
</script>
</body>
</html>
