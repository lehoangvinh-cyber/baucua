<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Center Online - B·∫ßu Cua & T√†i X·ªâu</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #d32f2f; --gold: #ffc107; --bg: #1a1a1a; --dark-card: #2c2c2c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; justify-content: center; }
        
        .game-container { width: 100%; max-width: 1000px; display: grid; grid-template-columns: 1fr 320px; gap: 20px; }
        @media (max-width: 900px) { .game-container { grid-template-columns: 1fr; } }
        
        .main-panel { background: var(--dark-card); padding: 20px; border-radius: 20px; border: 2px solid var(--gold); min-height: 500px; position: relative; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #333; padding: 12px; border-radius: 12px; margin-bottom: 20px; }
        
        /* Menu styles */
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 50px; }
        .menu-item { background: #333; border: 2px solid #444; border-radius: 15px; padding: 30px; text-align: center; cursor: pointer; transition: 0.3s; }
        .menu-item:hover { border-color: var(--gold); transform: translateY(-5px); }
        .menu-item img { width: 80px; height: 80px; margin-bottom: 10px; }

        /* Game Boards */
        .dice-board { display: flex; justify-content: center; gap: 15px; margin: 20px 0; background: #444; padding: 20px; border-radius: 15px; }
        .dice-board img { width: 70px; height: 70px; background: white; border-radius: 10px; border: 2px solid #666; }
        
        /* B·∫ßu Cua Table */
        .betting-table { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .bet-card { background: #3d3d3d; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #555; }
        .bet-card img { width: 45px; height: 45px; }
        .bet-card input { width: 80%; margin-top: 5px; border: none; padding: 5px; border-radius: 4px; text-align: center; }

        /* T√†i X·ªâu UI */
        .tx-bet-container { display: flex; gap: 15px; margin-top: 20px; }
        .tx-box { flex: 1; background: #333; padding: 20px; border-radius: 15px; text-align: center; border: 2px solid #444; cursor: pointer; }
        .tx-box.active { border-color: var(--gold); background: #444; }
        .tx-box h2 { margin: 0; font-size: 32px; color: var(--gold); }
        .tx-box input { width: 90%; margin-top: 10px; padding: 8px; border: none; border-radius: 5px; text-align: center; }

        /* Sidebar & Chat */
        .side-panel { display: flex; flex-direction: column; gap: 15px; }
        .box { background: #252525; border-radius: 15px; border: 1px solid #444; display: flex; flex-direction: column; overflow: hidden; }
        .box-title { background: #333; padding: 10px; font-weight: bold; color: var(--gold); font-size: 13px; text-align: center; }
        #chat-messages { height: 300px; overflow-y: auto; padding: 10px; font-size: 13px; scroll-behavior: smooth; }
        .chat-input-area { display: flex; padding: 10px; gap: 5px; background: #1a1a1a; }
        .chat-input-area input { flex: 1; padding: 8px; border-radius: 5px; border: none; background: #333; color: white; }
        #user-list { list-style: none; padding: 10px; margin: 0; max-height: 120px; overflow-y: auto; font-size: 12px; }

        /* Buttons & Utility */
        #play-btn { width: 100%; padding: 15px; background: var(--primary); color: white; font-size: 18px; font-weight: bold; border: none; border-radius: 10px; margin-top: 15px; cursor: pointer; }
        .shaking { animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: rotate(3deg); } 50% { transform: rotate(-3deg); } }
        .hidden { display: none; }
        .winner-msg { color: #4caf50; font-weight: bold; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<div id="auth-screen" style="margin-top: 100px; text-align: center;">
    <h1 style="color: var(--gold);">GAME CENTER ONLINE</h1>
    <button onclick="login()" style="padding: 15px 40px; font-size: 18px; cursor: pointer;">üîë ƒêƒÉng nh·∫≠p Google</button>
</div>

<div id="game-ui" class="game-container hidden">
    <div class="main-panel">
        <div class="header">
            <div>üëã <b id="user-name">...</b></div>
            <div style="color: var(--gold); font-size: 20px;">üí∞ <b id="balance">0</b></div>
            <button onclick="logout()" style="background:none; color:#888; border:none; cursor:pointer;">Tho√°t</button>
        </div>

        <div id="screen-menu">
            <h2 style="text-align:center; color: var(--gold);">CH·ªåN TR√í CH∆†I</h2>
            <div class="menu-grid">
                <div class="menu-item" onclick="changeScreen('bau-cua')">
                    <img src="https://cdn-icons-png.flaticon.com/512/2329/2329865.png"><br>B·∫ßu Cua
                </div>
                <div class="menu-item" onclick="changeScreen('tai-xiu')">
                    <img src="https://cdn-icons-png.flaticon.com/512/3554/3554832.png"><br>T√†i X·ªâu
                </div>
            </div>
        </div>

        <div id="screen-bau-cua" class="hidden">
            <button onclick="changeScreen('menu')" style="color:var(--gold); background:none; border:1px solid; cursor:pointer;">‚Üê Quay l·∫°i Menu</button>
            <div style="text-align: right; font-size: 12px; color: #888;">PHI√äN #<span id="session-bc">0</span></div>
            <div class="dice-board" id="board-bc">
                <img id="dice-bc-0" src="https://img.icons8.com/color/144/help.png">
                <img id="dice-bc-1" src="https://img.icons8.com/color/144/help.png">
                <img id="dice-bc-2" src="https://img.icons8.com/color/144/help.png">
            </div>
            <div class="betting-table" id="betting-table-bc"></div>
            <button onclick="playGame('bc')" id="play-btn-bc" class="hidden">X√ìC B·∫¶U CUA (HOST)</button>
        </div>

        <div id="screen-tai-xiu" class="hidden">
            <button onclick="changeScreen('menu')" style="color:var(--gold); background:none; border:1px solid; cursor:pointer;">‚Üê Quay l·∫°i Menu</button>
            <div style="text-align: right; font-size: 12px; color: #888;">PHI√äN #<span id="session-tx">0</span></div>
            <div class="dice-board" id="board-tx">
                <img id="dice-tx-0" src="https://img.icons8.com/ios-filled/100/ffffff/dice-six.png">
                <img id="dice-tx-1" src="https://img.icons8.com/ios-filled/100/ffffff/dice-six.png">
                <img id="dice-tx-2" src="https://img.icons8.com/ios-filled/100/ffffff/dice-six.png">
            </div>
            <div class="tx-bet-container">
                <div class="tx-box" id="box-tai" onclick="selectTX('tai')">
                    <h2>T√ÄI</h2><small>11 - 17</small><br>
                    <input type="number" id="input-tai" placeholder="S·ªë xu..." onclick="event.stopPropagation()">
                </div>
                <div class="tx-box" id="box-xiu" onclick="selectTX('xiu')">
                    <h2>X·ªàU</h2><small>4 - 10</small><br>
                    <input type="number" id="input-xiu" placeholder="S·ªë xu..." onclick="event.stopPropagation()">
                </div>
            </div>
            <button onclick="playGame('tx')" id="play-btn-tx" class="hidden">M·ªû B√ÅT (HOST)</button>
        </div>

        <p id="msg" style="text-align:center; font-weight:bold; margin-top:20px;"></p>
    </div>

    <div class="side-panel">
        <div class="box">
            <div class="box-title">üü¢ TR·ª∞C TUY·∫æN (<span id="online-count">0</span>)</div>
            <ul id="user-list"></ul>
        </div>
        <div class="box">
            <div class="box-title">üí¨ CH√ÅT T·ªîNG</div>
            <div id="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Nh·∫Øn tin...">
                <button onclick="sendChat()">></button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. FIREBASE CONFIG (THAY B·∫∞NG C·ª¶A B·∫†N) ---
    const firebaseConfig = {
        apiKey: "AIzaSyA41b97JGMfwxG8YYeS6gpNREJDdNTm1zs",
        authDomain: "game-ddf58.firebaseapp.com",
        databaseURL: "https://game-ddf58-default-rtdb.firebaseio.com",
        projectId: "game-ddf58",
        storageBucket: "game-ddf58.firebasestorage.app",
        messagingSenderId: "1044515984576",
        appId: "1:1044515984576:web:dfe285553142875849c925"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const items = [
        { id: 0, name: "B·∫ßu", img: "https://cdn-icons-png.flaticon.com/512/2329/2329865.png" },
        { id: 1, name: "Cua", img: "https://cdn-icons-png.flaticon.com/512/1046/1046368.png" },
        { id: 2, name: "T√¥m", img: "https://cdn-icons-png.flaticon.com/512/2515/2515183.png" },
        { id: 3, name: "C√°", img: "https://cdn-icons-png.flaticon.com/512/2271/2271313.png" },
        { id: 4, name: "G√†", img: "https://cdn-icons-png.flaticon.com/512/2632/2632839.png" },
        { id: 5, name: "Nai", img: "https://cdn-icons-png.flaticon.com/512/2395/2395796.png" }
    ];

    let currentUser = null, balance = 0, isHost = false;
    let myBCBets = [0,0,0,0,0,0], myTXBet = { type: null, amount: 0 };

    // Render B√†n c∆∞·ª£c B·∫ßu Cua
    const bcTable = document.getElementById("betting-table-bc");
    items.forEach(item => {
        bcTable.innerHTML += `<div class="bet-card"><img src="${item.img}"><br><input type="number" id="bet-bc-${item.id}" value="0"></div>`;
    });

    // --- 2. H·ªÜ TH·ªêNG M√ÄN H√åNH ---
    function changeScreen(screen) {
        ['screen-menu', 'screen-bau-cua', 'screen-tai-xiu'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById('screen-' + screen).classList.remove('hidden');
        document.getElementById('msg').innerText = "";
    }

    function selectTX(type) {
        myTXBet.type = type;
        document.getElementById('box-tai').classList.toggle('active', type === 'tai');
        document.getElementById('box-xiu').classList.toggle('active', type === 'xiu');
    }

    // --- 3. AUTH & ONLINE ---
    function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
    function logout() { auth.signOut(); location.reload(); }

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById("auth-screen").classList.add("hidden");
            document.getElementById("game-ui").classList.remove("hidden");
            document.getElementById("user-name").innerText = user.displayName;

            db.ref('online_users/' + user.uid).set({ name: user.displayName, joinTime: firebase.database.ServerValue.TIMESTAMP });
            db.ref('online_users/' + user.uid).onDisconnect().remove();

            db.ref('users/' + user.uid).on('value', snap => {
                balance = snap.val() ? snap.val().balance : 2000;
                document.getElementById("balance").innerText = balance.toLocaleString();
            });
        }
    });

    db.ref('online_users').orderByChild('joinTime').on('value', snap => {
        const list = document.getElementById("user-list"); list.innerHTML = "";
        let count = 0, users = [];
        snap.forEach(c => {
            users.push({ id: c.key });
            list.innerHTML += `<li>${c.val().name}${count === 0 ? ' ‚≠ê' : ''}</li>`;
            count++;
        });
        document.getElementById("online-count").innerText = count;
        isHost = (users.length > 0 && users[0].id === currentUser?.uid);
        ['bc', 'tx'].forEach(g => document.getElementById(`play-btn-${g}`).classList.toggle("hidden", !isHost));
    });

    // --- 4. CHAT LOGIC ---
    function sendChat() {
        const inp = document.getElementById("chat-input");
        if (!inp.value.trim()) return;
        db.ref('chats').push({ name: currentUser.displayName, text: inp.value });
        inp.value = "";
    }
    document.getElementById("chat-input").addEventListener("keypress", e => { if (e.key === "Enter") sendChat(); });
    db.ref('chats').limitToLast(15).on('value', snap => {
        const box = document.getElementById("chat-messages"); box.innerHTML = "";
        snap.forEach(c => { box.innerHTML += `<div><b>${c.val().name}:</b> ${c.val().text}</div>`; });
        box.scrollTop = box.scrollHeight;
    });

    // --- 5. ƒê·ªíNG B·ªò GAME B·∫¶U CUA ---
    db.ref('room_bc').on('value', snap => {
        const data = snap.val(); if (!data) return;
        document.getElementById("session-bc").innerText = data.sessionId || 0;
        const diceImgs = [document.getElementById("dice-bc-0"), document.getElementById("dice-bc-1"), document.getElementById("dice-bc-2")];
        if (data.status === "shaking") {
            if (!isHost) deductBC();
            diceImgs.forEach(img => img.classList.add("shaking"));
        } else if (data.status === "ready") {
            diceImgs.forEach((img, i) => { img.classList.remove("shaking"); img.src = items[data.dice[i]].img; });
            checkBC(data.dice);
        }
    });

    function deductBC() {
        let total = 0;
        for(let i=0; i<6; i++) {
            myBCBets[i] = parseInt(document.getElementById(`bet-bc-${i}`).value) || 0;
            total += myBCBets[i];
        }
        if (total > 0 && total <= balance) {
            balance -= total;
            db.ref('users/' + currentUser.uid).update({ balance: balance });
        }
    }

    // --- 6. ƒê·ªíNG B·ªò GAME T√ÄI X·ªàU ---
    db.ref('room_tx').on('value', snap => {
        const data = snap.val(); if (!data) return;
        document.getElementById("session-tx").innerText = data.sessionId || 0;
        const diceImgs = [document.getElementById("dice-tx-0"), document.getElementById("dice-tx-1"), document.getElementById("dice-tx-2")];
        if (data.status === "shaking") {
            if (!isHost) deductTX();
            diceImgs.forEach(img => img.classList.add("shaking"));
        } else if (data.status === "ready") {
            let sum = 0;
            data.dice.forEach((v, i) => {
                sum += v;
                diceImgs[i].classList.remove("shaking");
                diceImgs[i].src = `https://img.icons8.com/ios-filled/100/ffffff/dice-${['one','two','three','four','five','six'][v-1]}.png`;
            });
            checkTX(data.dice, sum);
        }
    });

    function deductTX() {
        const val = parseInt(document.getElementById(`input-${myTXBet.type}`).value) || 0;
        myTXBet.amount = val;
        if (val > 0 && val <= balance) {
            balance -= val;
            db.ref('users/' + currentUser.uid).update({ balance: balance });
        }
    }

    // --- 7. PLAY FUNCTIONS (HOST ONLY) ---
    function playGame(game) {
        if (!isHost) return;
        if (game === 'bc') deductBC(); else deductTX();
        const room = game === 'bc' ? 'room_bc' : 'room_tx';
        db.ref(room).update({ status: "shaking", sessionId: firebase.database.ServerValue.increment(1) });
        setTimeout(() => {
            const res = game === 'bc' ? [rand(6), rand(6), rand(6)] : [rand(6)+1, rand(6)+1, rand(6)+1];
            db.ref(room).update({ dice: res, status: "ready" });
        }, 1500);
    }

    function rand(n) { return Math.floor(Math.random() * n); }

    // --- 8. KI·ªÇM TRA TH·∫ÆNG THUA ---
    function checkBC(res) {
        let win = 0; res.forEach(id => { if(myBCBets[id] > 0) win += myBCBets[id] * 2; });
        if (win > 0) {
            balance += win; db.ref('users/' + currentUser.uid).update({ balance: balance });
            document.getElementById('msg').innerHTML = `<span style="color:#4caf50">B·∫¶U CUA: TH·∫ÆNG +${win}</span>`;
        }
        myBCBets = [0,0,0,0,0,0]; 
        for(let i=0; i<6; i++) document.getElementById(`bet-bc-${i}`).value = 0;
    }

    function checkTX(dice, sum) {
        const result = sum >= 11 ? "tai" : "xiu";
        let win = 0; if (myTXBet.type === result) win = myTXBet.amount * 2;
        if (win > 0) {
            balance += win; db.ref('users/' + currentUser.uid).update({ balance: balance });
            document.getElementById('msg').innerHTML = `<span style="color:#4caf50">T√ÄI X·ªàU: TH·∫ÆNG +${win} (${sum}ƒë - ${result.toUpperCase()})</span>`;
        } else if (myTXBet.amount > 0) {
            document.getElementById('msg').innerHTML = `<span style="color:#ff5252">T√ÄI X·ªàU: THUA (${sum}ƒë - ${result.toUpperCase()})</span>`;
        }
        myTXBet = { type: null, amount: 0 };
        ['tai', 'xiu'].forEach(t => { 
            document.getElementById(`input-${t}`).value = ""; 
            document.getElementById(`box-${t}`).classList.remove('active');
        });
    }
</script>
</body>
</html>
