<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiÃªu á»¨ng Dá»¥ng Game Online v4.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #ff3d00; --gold: #ffc400; --bg: #0a0b10; --card: #161b22; --green: #1b5e20; }
        body { font-family: 'Lexend', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 10px; display: flex; justify-content: center; }
        
        .app-grid { width: 100%; max-width: 1200px; display: grid; grid-template-columns: 1fr 320px; gap: 20px; }
        @media (max-width: 900px) { .app-grid { grid-template-columns: 1fr; } }
        
        .main-stage { background: var(--card); padding: 20px; border-radius: 25px; border: 1px solid #30363d; min-height: 600px; position: relative; }
        .nav { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 15px; margin-bottom: 20px; }
        
        /* Game Board */
        .dice-board { display: flex; justify-content: center; gap: 15px; margin: 20px 0; background: #0d1117; padding: 25px; border-radius: 20px; }
        .dice-board img { width: 70px; height: 70px; background: #fff; border-radius: 12px; padding: 5px; }
        
        /* Äua ngá»±a */
        .track { background: var(--green); padding: 10px; border-radius: 15px; border: 3px solid #000; position: relative; }
        .lane { height: 45px; border-bottom: 1px dashed rgba(255,255,255,0.2); position: relative; display: flex; align-items: center; width: 100%; }
        .horse { font-size: 28px; position: absolute; left: 0; transition: left 0.2s linear; white-space: nowrap; }

        /* Sidebar & Auth */
        .side-box { background: var(--card); border-radius: 20px; border: 1px solid #30363d; margin-bottom: 15px; overflow: hidden; }
        #chat-content, #hist-content { height: 250px; overflow-y: auto; padding: 15px; font-size: 13px; scroll-behavior: smooth; }
        .auth-card { background: var(--card); padding: 40px; border-radius: 25px; border: 1px solid var(--gold); width: 350px; text-align: center; margin-top: 100px; }
        .auth-card input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #30363d; background: #0d1117; color: #fff; }

        /* Menu */
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 30px; }
        .menu-item { background: #21262d; border: 1px solid #30363d; border-radius: 20px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; }
        .menu-item:hover { border-color: var(--gold); transform: translateY(-3px); }
        .menu-item b { font-size: 40px; display: block; margin-bottom: 10px; }

        .hidden { display: none; }
        .shaking { animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: rotate(3deg); } 50% { transform: rotate(-3deg); } }
        #play-btn { width: 100%; padding: 15px; background: var(--primary); color: #fff; border: none; border-radius: 12px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 20px; box-shadow: 0 4px #b71c1c; }
        .active-bet { border: 2px solid var(--gold) !important; background: rgba(255,196,0,0.1) !important; }
    </style>
</head>
<body>

<div id="view-auth" class="auth-card">
    <h2 style="color: var(--gold);">INFINITY GAME</h2>
    <input type="text" id="reg-name" placeholder="TÃªn hiá»ƒn thá»‹" class="hidden">
    <input type="email" id="acc-email" placeholder="Email">
    <input type="password" id="acc-pass" placeholder="Máº­t kháº©u">
    <button onclick="handleAuth()" id="btn-auth" style="width:100%; padding:12px; background:var(--gold); border:none; border-radius:10px; font-weight:bold; cursor:pointer;">VÃ o Game</button>
    <p onclick="forgotPass()" style="color:var(--primary); font-size:12px; cursor:pointer; margin-top:15px;">QuÃªn máº­t kháº©u?</p>
    <p onclick="toggleAuth()" id="toggle-txt" style="color:#aaa; font-size:13px; cursor:pointer;">ChÆ°a cÃ³ tÃ i khoáº£n? ÄÄƒng kÃ½</p>
</div>

<div id="view-game" class="app-grid hidden">
    <div class="main-stage">
        <div class="nav">
            <div>ğŸ‘‹ <b id="user-name">...</b></div>
            <select id="mode-sel" onchange="switchMode()" style="background:#000; color:#fff; border:1px solid #30363d; padding:5px; border-radius:8px;">
                <option value="multi">ğŸŒ ChÆ¡i Chung</option>
                <option value="solo">ğŸ‘¤ ChÆ¡i RiÃªng</option>
            </select>
            <div style="color: var(--gold); font-size: 18px;">ğŸ’° <b id="balance">0</b></div>
            <button onclick="logout()" style="background:none; border:none; color:#ff4444; cursor:pointer;">ThoÃ¡t</button>
        </div>

        <div id="status-msg" style="text-align:center; font-weight:bold; color: var(--gold); min-height: 25px;"></div>

        <div id="screen-menu" class="menu-grid">
            <div class="menu-item" onclick="openGame('bc')"><b>ğŸ²</b>Báº§u Cua</div>
            <div class="menu-item" onclick="openGame('tx')"><b>ğŸ’°</b>TÃ i Xá»‰u</div>
            <div class="menu-item" onclick="openGame('xd')"><b>ğŸ”´</b>XÃ³c ÄÄ©a</div>
            <div class="menu-item" onclick="openGame('dn')"><b>ğŸ‡</b>Äua Ngá»±a</div>
        </div>

        <div id="screen-bc" class="hidden">
            <button onclick="openGame('menu')" style="color:#888; background:none; border:none; cursor:pointer;">â† Quay láº¡i</button>
            <div class="dice-board"><img id="d-bc-0" src=""><img id="d-bc-1" src=""><img id="d-bc-2" src=""></div>
            <div id="bc-bets" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;"></div>
        </div>

        <div id="screen-tx" class="hidden">
            <button onclick="openGame('menu')" style="color:#888; background:none; border:none; cursor:pointer;">â† Quay láº¡i</button>
            <div class="dice-board">
                <img id="d-tx-0" src="https://img.icons8.com/ios-filled/100/ffffff/dice-one.png">
                <img id="d-tx-1" src="https://img.icons8.com/ios-filled/100/ffffff/dice-one.png">
                <img id="d-tx-2" src="https://img.icons8.com/ios-filled/100/ffffff/dice-one.png">
            </div>
            <div style="display:flex; gap:10px;">
                <div id="btn-tai" class="menu-item" style="flex:1" onclick="selTX('tai')"><h2>TÃ€I</h2><input type="number" id="val-tai" placeholder="Sá»‘ xu..."></div>
                <div id="btn-xiu" class="menu-item" style="flex:1" onclick="selTX('xiu')"><h2>Xá»ˆU</h2><input type="number" id="val-xiu" placeholder="Sá»‘ xu..."></div>
            </div>
        </div>

        <div id="screen-dn" class="hidden">
            <button onclick="openGame('menu')" style="color:#888; background:none; border:none; cursor:pointer;">â† Quay láº¡i</button>
            <div class="track" style="margin:20px 0;">
                <div class="lane"><div id="h-0" class="horse">ğŸ‡1</div></div>
                <div class="lane"><div id="h-1" class="horse">ğŸ‡2</div></div>
                <div class="lane"><div id="h-2" class="horse">ğŸ‡3</div></div>
                <div class="lane"><div id="h-3" class="horse">ğŸ‡4</div></div>
            </div>
            <div id="dn-bets" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px;"></div>
        </div>

        <button id="play-btn" class="hidden" onclick="masterRun()">Báº®T Äáº¦U PHIÃŠN</button>
    </div>

    <div class="side-panel">
        <div class="side-box"><div style="padding:10px; font-weight:bold; color:var(--gold);">ğŸ“œ Lá»ŠCH Sá»¬</div><div id="hist-content"></div></div>
        <div class="side-box">
            <div id="chat-content"></div>
            <div style="display:flex; padding:10px; gap:5px; background:#0d1117;">
                <input type="text" id="chat-inp" placeholder="Chat..." style="flex:1; border:none; background:#21262d; color:#fff; padding:8px; border-radius:5px;">
                <button onclick="sendChat()" style="background:var(--gold); border:none; padding:0 12px; border-radius:5px; cursor:pointer;">></button>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
  apiKey: "AIzaSyA41b97JGMfwxG8YYeS6gpNREJDdNTm1zs",
  authDomain: "game-ddf58.firebaseapp.com",
  databaseURL: "https://game-ddf58-default-rtdb.firebaseio.com",
  projectId: "game-ddf58",
  storageBucket: "game-ddf58.firebasestorage.app",
  messagingSenderId: "1044515984576",
  appId: "1:1044515984576:web:dfe285553142875849c925",
  measurementId: "G-0Q7VVDPWRP"
};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); const db = firebase.database();

    let curScr = 'menu'; let balance = 0; let isHost = false; let user = null; let isReg = false; let pMode = 'multi';
    let bets = { bc: [0,0,0,0,0,0], tx: {t:null, v:0}, dn: [0,0,0,0] };
    const bcImgs = ['2329865','1046368','2515183','2271313','2632839','2395796'];

    // Khá»Ÿi táº¡o bÃ n cÆ°á»£c
    bcImgs.forEach((id, idx) => {
        document.getElementById('bc-bets').innerHTML += `<div style="background:#21262d; padding:10px; border-radius:15px; text-align:center;"><img src="https://cdn-icons-png.flaticon.com/512/${id}/${id}.png" style="width:40px;"><br><input type="number" id="in-bc-${idx}" style="width:80%; background:#000; color:var(--gold); border:none; text-align:center;" placeholder="0"></div>`;
    });
    for(let i=0; i<4; i++) {
        document.getElementById('dn-bets').innerHTML += `<div style="background:#21262d; padding:10px; border-radius:15px; text-align:center;">ğŸ‡${i+1}<br><input type="number" id="in-dn-${i}" style="width:80%; background:#000; color:var(--gold); border:none; text-align:center;" placeholder="0"></div>`;
    }

    // --- AUTH ---
    function toggleAuth() { isReg = !isReg; document.getElementById('reg-name').classList.toggle('hidden', !isReg); document.getElementById('btn-auth').innerText = isReg ? "ÄÄƒng kÃ½" : "VÃ o Game"; }
    function handleAuth() {
        const e = document.getElementById('acc-email').value, p = document.getElementById('acc-pass').value, n = document.getElementById('reg-name').value;
        if(isReg) auth.createUserWithEmailAndPassword(e, p).then(u => u.user.updateProfile({displayName: n})).then(() => location.reload()).catch(err => alert(err.message));
        else auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
    }
    auth.onAuthStateChanged(u => {
        if(u) {
            user = u; document.getElementById('view-auth').classList.add('hidden'); document.getElementById('view-game').classList.remove('hidden');
            document.getElementById('user-name').innerText = u.displayName || u.email.split('@')[0];
            db.ref('users/'+u.uid).on('value', s => { balance = s.val()?.bal || 2000; if(!s.val()) db.ref('users/'+u.uid).set({bal: 2000}); document.getElementById('balance').innerText = balance.toLocaleString(); });
            db.ref('hist/'+u.uid).limitToLast(10).on('value', s => {
                const h = document.getElementById('hist-content'); h.innerHTML = ""; let a = []; s.forEach(c => a.unshift(c.val()));
                a.forEach(i => h.innerHTML += `<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #333;"><span>${i.g}</span><b style="color:${i.a>0?'#4caf50':'#f44336'}">${i.a>0?'+':''}${i.a}</b></div>`);
            });
            db.ref('online/'+u.uid).set({name: u.displayName||u.email, t: Date.now()}); db.ref('online/'+u.uid).onDisconnect().remove();
        }
    });

    // --- LOGIC GAME ---
    function openGame(s) { ['menu','bc','tx','dn'].forEach(x => document.getElementById('screen-'+x).classList.add('hidden')); document.getElementById('screen-'+s).classList.remove('hidden'); curScr = s; switchMode(); }
    
    function switchMode() {
        pMode = document.getElementById('mode-sel').value;
        if(pMode === 'solo') { document.getElementById('play-btn').classList.remove('hidden'); }
        else {
            db.ref('online').orderByChild('t').on('value', s => {
                let us = []; s.forEach(c => us.push(c.key)); isHost = (us[0] === user?.uid);
                document.getElementById('play-btn').classList.toggle('hidden', !isHost);
            });
        }
    }

    function masterRun() {
        if(pMode === 'multi' && !isHost) return;
        let t = 0; // TÃ­nh tá»•ng cÆ°á»£c
        if(curScr==='bc') for(let i=0;i<6;i++) t += parseInt(document.getElementById('in-bc-'+i).value)||0;
        if(curScr==='tx') t = parseInt(document.getElementById('val-'+bets.tx.t)?.value)||0;
        if(curScr==='dn') for(let i=0;i<4;i++) t += parseInt(document.getElementById('in-dn-'+i).value)||0;
        
        if(t > balance) return alert("Háº¿t xu!");
        if(t <= 0 && pMode === 'solo') return alert("CÆ°á»£c Ä‘i!");

        deduct();
        if(pMode === 'solo') {
            if(curScr === 'dn') startLocalRace(); else localShake();
        } else {
            const r = 'room_'+curScr; db.ref(r+'/sid').transaction(c => (c||0)+1);
            if(curScr === 'dn') startGlobalRace(r);
            else {
                db.ref(r).update({st: 'shaking'});
                setTimeout(() => db.ref(r).update({st: 'ready', res: genRes(), t: Date.now()}), 1500);
            }
        }
    }

    function deduct() {
        let t = 0;
        if(curScr==='bc') for(let i=0;i<6;i++) { bets.bc[i] = parseInt(document.getElementById('in-bc-'+i).value)||0; t+=bets.bc[i]; }
        if(curScr==='tx') { bets.tx.v = parseInt(document.getElementById('val-'+bets.tx.t)?.value)||0; t=bets.tx.v; }
        if(curScr==='dn') for(let i=0;i<4;i++) { bets.dn[i] = parseInt(document.getElementById('in-dn-'+i).value)||0; t+=bets.dn[i]; }
        if(t > 0) { db.ref('users/'+user.uid).update({bal: balance - t}); db.ref('hist/'+user.uid).push({g: curScr.toUpperCase(), a: -t}); }
    }

    function genRes() {
        if(curScr === 'bc') return [rand(6), rand(6), rand(6)];
        if(curScr === 'tx') return [rand(6)+1, rand(6)+1, rand(6)+1];
    }

    function rand(n) { return Math.floor(Math.random()*n); }

    function localShake() {
        document.querySelectorAll('#screen-'+curScr+' img').forEach(i => i.classList.add('shaking'));
        setTimeout(() => {
            document.querySelectorAll('#screen-'+curScr+' img').forEach(i => i.classList.remove('shaking'));
            let r = genRes(); showRes(r); calc(r);
        }, 1500);
    }

    function showRes(r) {
        if(curScr==='bc') r.forEach((v,i) => document.getElementById('d-bc-'+i).src = `https://cdn-icons-png.flaticon.com/512/${bcImgs[v]}/${bcImgs[v]}.png`);
        if(curScr==='tx') r.forEach((v,i) => document.getElementById('d-tx-'+i).src = `https://img.icons8.com/ios-filled/100/ffffff/dice-${['one','two','three','four','five','six'][v-1]}.png`);
    }

    function startLocalRace() {
        let p = [0,0,0,0]; 
        let t = setInterval(() => {
            p = p.map(x => x + rand(8) + 2);
            p.forEach((v,i) => document.getElementById('h-'+i).style.left = (v>90?90:v)+'%');
            if(p.some(x => x>=90)) { clearInterval(t); let w = p.indexOf(Math.max(...p)); calc(p, w); }
        }, 100);
    }

    function startGlobalRace(r) {
        let p = [0,0,0,0];
        let t = setInterval(() => {
            p = p.map(x => x + rand(8) + 2);
            if(p.some(x => x>=90)) {
                clearInterval(t); let w = p.indexOf(Math.max(...p));
                db.ref(r).update({st: 'ready', res: p, win: w, t: Date.now()});
            } else { db.ref(r).update({st: 'shaking', res: p}); }
        }, 200);
    }

    function calc(r, winIdx) {
        let w = 0;
        if(curScr==='bc') r.forEach(v => { if(bets.bc[v]>0) w += bets.bc[v]*2; });
        if(curScr==='tx') { const s = r.reduce((a,b)=>a+b,0), res = s>=11?'tai':'xiu'; if(bets.tx.t === res) w = bets.tx.v*2; }
        if(curScr==='dn') { if(bets.dn[winIdx]>0) w = bets.dn[winIdx]*4; }
        
        if(w > 0) { db.ref('users/'+user.uid).update({bal: balance + w}); db.ref('hist/'+user.uid).push({g: curScr.toUpperCase(), a: w}); document.getElementById('status-msg').innerText = "THáº®NG +"+w; }
        bets = { bc: [0,0,0,0,0,0], tx: {t:null, v:0}, dn: [0,0,0,0] };
        document.querySelectorAll('input').forEach(i => { if(i.id.includes('in-') || i.id.includes('val-')) i.value = ""; });
    }

    // --- SYNC MULTI ---
    ['bc','tx','dn'].forEach(g => {
        db.ref('room_'+g).on('value', s => {
            const d = s.val(); if(!d || curScr !== g || pMode === 'solo') return;
            if(d.st === 'shaking') {
                if(!isHost) deduct();
                if(g==='dn') d.res.forEach((v,i) => document.getElementById('h-'+i).style.left = v+'%');
                else document.querySelectorAll('#screen-'+g+' img').forEach(i => i.classList.add('shaking'));
            } else if(d.st === 'ready') {
                document.querySelectorAll('#screen-'+g+' img').forEach(i => i.classList.remove('shaking'));
                if(g==='dn') { d.res.forEach((v,i) => document.getElementById('h-'+i).style.left = v+'%'); calc(d.res, d.win); }
                else { showRes(d.res); calc(d.res); }
            }
        });
    });

    // --- CHAT ---
    function sendChat() { const i = document.getElementById('chat-inp'); if(i.value) { db.ref('chat').push({n:user.displayName, t:i.value}); i.value=""; } }
    db.ref('chat').limitToLast(12).on('value', s => {
        const c = document.getElementById('chat-content'); c.innerHTML = "";
        s.forEach(x => c.innerHTML += `<div><b>${x.val().n}:</b> ${x.val().t}</div>`); c.scrollTop = c.scrollHeight;
    });

    function selTX(t) { bets.tx.t = t; document.getElementById('btn-tai').classList.remove('active-bet'); document.getElementById('btn-xiu').classList.remove('active-bet'); document.getElementById('btn-'+t).classList.add('active-bet'); }
</script>
</body>
</html>
